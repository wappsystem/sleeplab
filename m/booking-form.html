<div id=D__ID>
	<!--third html start -->
	<div class="container mt-95 mb-3">
		<div class="row">
			<!-- form container start -->
			<div class="col-12 col-lg-12 col-md-12 col-sm-12 mx-auto formbox">
				<div class="row">
					<div class="col-12">
						<!-- form start -->
						<form id="F__ID">
							<h3>Sleep Study Booking Record</h3>
							<div class="form-group ">
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<div class="row">
											<div class="col-lg-6 col-sm-12">
												<div><label><span class="">Date</span></label></div>
												<div class="input-group-sm ">
													<input type="date" class="form-control" name=Date />
												</div>
											</div>
											<div class="col-lg-6 col-sm-12">
												<div><label><span class="">Arrival Time</span></label></div>
												<div class="input-group-sm">
													<select class="form-control" name=Time>
													</select>												
												</div>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<div class="form-group ">
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<div class="row">
											<div class="col-lg-6 col-sm-12">
												<div><label><span class="">Appointment for</span></label></div>
												<div class="input-group-sm ">
													<input type="text" class="form-control" name=Appointment required placeholder="lookup..." />
												</div>
											</div>
											<div class="col-lg-2 col-sm-12">
												<div><label><span class="">Appointment ID</span></label></div>
												<div class="input-group-sm">
													<input type="text" class="form-control" name=Appointment_uid required readonly />
												</div>
											</div>
											<div class="col-lg-2 col-sm-12">
												<div><label><span class="">Login ID</span></label></div>
												<div class="input-group-sm">
													<input type="text" class="form-control" id=login_id__ID readonly />
												</div>
											</div>
											<div class="col-lg-2 col-sm-12">
												<div><label><span class="">Password</span></label></div>
												<div class="input-group-sm">
													<input type="text" class="form-control" name=_Password readonly />
												</div>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<div class="form-group ">
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<div class="row">
											<div class="col-lg-12 col-sm-12">
												<div><label><span class="">Item Number - Procedure</span></label></div>
												<div class="input-group-sm ">
													<input type="text" class="form-control" name=Item_Number_Procedure  placeholder="lookup..." />
													<input type="text" class="form-control" name=Item_Number style='display:none' />
												</div>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<div class="form-group" style='display:none!important'>
								<div class="questiongroup ">
									<fieldset class="">
										<div class="row">
											<div class="col-lg-4 col-sm-12">
												<label ><span class="">Colour</span>
													<input type="text" class="form-control" name=Colour readonly />
												</label><br>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<div class="form-group" style='display:xnone!important'>
								<div class="questiongroup ">
									<fieldset class="">
										<div class="row">
											<div class="col-lg-6 col-sm-12">
												<label style='width:100%'><span class="">Questionnaire Evening List</span>
													<input type="text" class="form-control" name=Evening_list readonly />
												</label><br>
											</div>
											<div class="col-lg-6 col-sm-12">
												<label ><span class="">Questionnaire Morning List</span>
													<input type="text" class="form-control" name=Morning_list readonly />
												</label><br>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<div class="form-group ">
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<div class="row">
											<div class="col-lg-6 col-sm-12">
												<div><label><span class="">Charge</span></label></div>
												<div class="input-group-sm ">
													<select class="form-control" name=Charge id=Charge__ID >
														<option >Medicare</option>
														<option >Self funded</option>
														<option >Research</option>
														<option >No Fee</option>
													</select>							
												</div>
											</div>
											<div class="col-lg-6 col-sm-12" id=research__ID >
												<div><label><span class="">Research Project</span></label></div>
												<div class="input-group-sm">
													<input type="text" class="form-control" name=Research_Project placeholder="lookup..." />
												</div>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<div class="form-group ">
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<div class="row">
											<div class="col-lg-6 col-sm-12">
												<div><label><span class="">Referrer</span></label></div>
												<div class="input-group-sm ">
													<input type="text" class="form-control" name=Referrer placeholder="lookup..." />
												</div>
											</div>
											<div class="col-lg-3 col-sm-12">
												<div><label><span class="">Provider Number</span></label></div>
												<div class="input-group-sm">
													<input type="text" class="form-control" name=Referrer_Provider_Number readonly />
												</div>
											</div>
											<div class="col-lg-3 col-sm-12">
												<div><label><span class="">Referral</span></label></div>
												<label class="checkboxes">
													<input type="checkbox" name="Referral">
													<span class="check_checkmark"></span> Provided
												</label>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<div class="form-group ">
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<div class="row">
											<div class="col-lg-12 col-sm-12">
												<div class="input-group-sm ">
													<label><span id=medicare_referral__ID style='cursor: pointer;'><u>View Medicare and Referral Form</u>
													</span></label>
												</div>
											</div>
										</div>
									</fieldset>
								</div>
							</div>	
							<div id=send_report__ID>
								<div class="form-group ">
									<div class="questiongroup ">
										<fieldset class="subquestions">
											<div class="row">
												<div class="col-lg-12 col-sm-12">
													<div><label><span class="">Send report to</span></label></div>
													<div class="input-group-sm ">
														<input type="text" class="form-control" name=Report_send_to placeholder="lookup..." />
														<label><span><u style='cursor:pointer;margin-bottom:3px;display:inline-block' id=item_a_add__ID><i class="fa fa-plus"></i> Add to list</u></span></label>
													</div>
												</div>
											</div>
										</fieldset>
									</div>
								</div>
								<div class="form-group ">
									<div class="questiongroup ">
										<fieldset class="subquestions">
											<div class="row">
												<div class="col-lg-12 col-sm-12">
													<div class="input-group-sm ">
														<label><span>
															<table id=grid_item_a__ID></table>
														</span></label>
													</div>
												</div>
											</div>
										</fieldset>
									</div>
								</div>	
							</div>
							<div class="form-group ">
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<div class="row">
											<div class="col-lg-12 col-sm-12">
												<div><label><span class="">Special Needs</span></label></div>
												<div class="input-group-sm ">
													<textarea style='font-size:small' class="form-control" name=Special_Needs ></textarea>
												</div>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<div class="form-group ">
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<div class="row">
											<div class="col-lg-12 col-sm-12">
												<div class="input-group-sm ">
													<label><span class=""><u style='cursor:pointer;margin-bottom:3px;display:inline-block' id=add_comment__ID><i class="fa fa-plus"></i> Click here to add comment</u></span></label>
													<textarea class="form-control" id=Add_Comment__ID placeholder="enter new comments here.." ></textarea>
												</div>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<div class="form-group ">
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<div class="row">
											<div class="col-lg-12 col-sm-12">
												<div><label><span class="">Comments</span></label></div>
												<div class="input-group-sm ">
													<textarea style='font-size:small' class="form-control" name=Comments readonly ></textarea>
												</div>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<div class="form-group ">
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<div class="row">
											<div class="col-lg-3 col-sm-12">
												<div><label><span class="">Cancelled</span></label></div>
												<label class="checkboxes">
													<input type="checkbox" name="Cancelled">
													<span class="check_checkmark"></span>
												</label>
											</div>
											<div class="col-lg-9 col-sm-12">
												<div><label><span class="">Cancelled Reason</span></label></div>
												<div class="input-group-sm ">
													<textarea type="text" class="form-control" name=Cancelled_Reason ></textarea>
												</div>
											</div>
										</div>
									</fieldset>
								</div>
							</div>
							<button type="submit" id="submit__ID" class="btn btn-primary btn-lg">Submit</button>
							<button id=delete__ID type="button" class="btn btn-primary btn-lg">Delete</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
	function F__ID() {
		//-------------------------------------
		VmInclude: __COMPONENT__/f/form.01.js
		VmInclude: __COMPONENT__/f/form-item-a.01.js
		//-------------------------------------
		var $List1 = $('#F__ID select[name=Time]');
		for (var i = 12; i < 24; i++) {
			for (var j = 0; j < 2; j++) {
				var t1 = i; if (t1 < 10) t1 = "0" + t1
				var t2 = j * 30; if (t2 == 0) t2 = "00";
				var t = t1 + ":" + t2;
				$List1.append($('<option></option>').val(t).html(t));
			}
		}
		//-------------------------------------
		var $List2 = $('#F__ID select[name=Duration]');
		for (var i = 0; i < 15; i++) {
			for (var j = 0; j < 2; j++) {
				var t1 = i; if (t1 < 10) t1 = "0" + t1
				var t2 = j * 30; if (t2 == 0) t2 = "00";
				var t = t1 + ":" + t2;
				if (i == 0 && j == 0) { }
				else $List2.append($('<option></option>').val(t).html(t));
			}
		}
		//-------------------------------------
		var query={};
		var a_rid;
		//-------------------------------------
		old_load = m.load;
		m.load = function () {
			old_load();
			//console.log("BBBBB: "+JSON.stringify(m.lookup))
			$('#add__ID').hide();
			if (m.input != undefined && m.input.record != undefined && m.input.record._id !== undefined) {
				$('#send_report__ID').show();
				$('input[name=Item_Number_Procedure]').css('background-color', m.input.record.Data.Colour);
				$('input[name=Item_Number_Procedure]').css('color', $vm.whire_or_black_color(m.input.record.Data.Colour));
				//if ($('#Charge__ID').val() == "Research") {$('#research__ID').css('display', 'block');}
				//else { $('#research__ID').css('display', 'none'); $('input[name=Research_Project]').val(""); }
			}
			else {
				$('#send_report__ID').hide();
				$('input[name=Colour]').val('#fefefe')
			}
			if (m.input.day != undefined) {
				$('#F__ID input[name=Date]').val(m.input.day);
			}
			if(m.input.appointment!=undefined){
				$('input[name=Appointment]').val(m.input.appointment.Data.First_Name+' '+m.input.appointment.Data.Last_Name);
				$('input[name=Appointment_uid]').val(m.input.appointment.UID);
				$('input[name=pw]').val(m.input.appointment.Data._Password)
			}
			//-------item a part
			if (m.input.record != undefined) {
				$('#login_id__ID').val(m.input.record.UID)
				if(m.input.record.Data._Password==undefined) $('#F__ID input[name=_Password').val($vm.vm_password(8, false));
				if (m.input.record.Data.items == undefined) m.input.record.Data.items = [];
				m.item_a_records = m.input.record.Data.items;
				m.item_a_render();
			}
			else{
				$('#F__ID input[name=_Password').val($vm.vm_password(8, false));
			}
			//-------
		}
		//-------------------------------------
		var make_questionnaire_list=function(uid){
			var req={ cmd: "find", query:{"UID":uid}, table: m.lookup2, options: {}, skip: 0, limit: 10 }
			$vm.request(req,function(res){
				if (res.result.length==1){
					var list=""
					if(res.result[0].Data.evening!=undefined){
						for(var i=0;i<res.result[0].Data.evening.length;i++){
							if(i>0){
								list+=","+res.result[0].Data.evening[i].Module_link;
							}
							else{
								list=res.result[0].Data.evening[i].Module_link;
							}
						}
					}
					$('#F__ID input[name=Evening_list]').val(list);
					var list=""
					if(res.result[0].Data.morning!=undefined){
						for(var i=0;i<res.result[0].Data.morning.length;i++){
							if(i>0){
								list+=","+res.result[0].Data.morning[i].Module_link;
							}
							else{
								list=res.result[0].Data.morning[i].Module_link;
							}
						}
					}
					$('#F__ID input[name=Morning_list]').val(list);
				}
			});
		};
		//-------------------------------------
		$('#medicare_referral__ID').on('click', function () {
			if(m.input.appointment!=undefined){
				$vm.request({cmd:"find",table:$vm.module_list['medicare-referrals-form'].Table,query:{I3:(m.input.appointment.UID).toString()},options:{}},function(res){
					//console.log(JSON.stringify(res.result))
					if(res.result.length==1){
						var record=res.result[0]
						$vm.load_module('medicare-referrals-form','',{record:record,readonly:'Yes',goback:1})
					}
					else $vm.alert("This form was not filled in");
				})
			}
		});
		//-------------------------------------
		$('#add_comment__ID').on('click', function () {
			var now_time = new Date();
			now_time = now_time.toString().split(" ");
			now_time = now_time[4];
			var now_date = $vm.date_to_string_dmy(new Date());
			var new_comments = $('#Add_Comment__ID').val();
			if (new_comments != "") {
				var old_comments = $('#F__ID textarea[name=Comments]').val()
				if ($('#F__ID textarea[name=Comments]').val() == undefined) old_comments = "";
				var comments = now_time + ' ' + now_date + " - " + $vm.user_name + "\n" + new_comments + "\n\n" + old_comments
				$('#F__ID textarea[name=Comments]').val(comments)
				$('#Add_Comment__ID').val("");
			}
			else $vm.alert("Please enter a comment")
		})
		//-------------------------------------
		$('#Charge__ID').change(function () {
			//if ($('#Charge__ID').val() == "Research") $('#research__ID').css('display', 'block');
			//else { $('#research__ID').css('display', 'none'); $('input[name=Research_Project').val(""); }
		})
		//-------------------------------------
		$('#F__ID input[name=Date]').change(function () {
			var change_date=$('#F__ID input[name=Date]').val()
			var dt1=change_date;
			var dt2=$vm.date_to_yyyymmdd($vm.date_add_days($vm.date_yyyymmdd_parse(change_date),1));
			query={I1:{"$gte":dt1,"$lt":dt2}}
			//console.log(JSON.stringify(query))
			autocomplete_req = { cmd: "find", field: '.Data.Last_Name', table: m.lookup5,query:query, options: {}, skip: 0, limit: 10 }
			$vm.autocomplete($('#F__ID input[name=Appointment'), autocomplete_req, autocomplete_list, autocomplete_callback);
		})
		//-------------------------------------
		m.before_submit = function (data, index) {
			index.I1 = data.Date;
			index.I2 = data.Time;
			index.I3 = data.Duration;
		}
		//-------------------------------------
		m.after_insert= function(data, index){
			if(data.Appointment_uid!=""){
				var data_a={};
				var index_a={};
				var a_rid;
				$vm.request({cmd:'find',query:{UID:parseInt(data.Appointment_uid)},table:m.lookup},function(res){
					//console.log(JSON.stringify(res.result));
					if(res.result.length==1){
						data_a=res.result[0].Data;
						data_a.Date=data.Date;
						data_a.Time=data.Time;
						index_a.I1 = data.Date;
						index_a.I2 = data.Time;
						a_rid=res.result[0]._id;
					}
					//console.log("AAA: "+JSON.stringify(data_a))
					//console.log("BBB: "+JSON.stringify(index_a))
					$vm.request({cmd:'update',id:a_rid,table:m.lookup,data:data_a,index:index_a},function(res){
						if(res.status=="lk"){
							$vm.alert("This record is locked.");
							return;
						}
						//-----------------------------
						if(res.status=="np"){
							$vm.alert("No permission to update this record.");
							return;
						}
					})
				});
				window.history.go(-1);
			}
		}
		//-------------------------------------
		if(m.input.record!=undefined){
			if(m.input.day==undefined){
				m.input.day=m.input.record.I1
			}
			//console.log(JSON.stringify(m.input))
			var dt1=m.input.day;
			var dt2=$vm.date_to_yyyymmdd($vm.date_add_days($vm.date_yyyymmdd_parse(dt1),1));
			query={I1:{"$gte":dt1,"$lt":dt2}};
		}
		else query={I1:""};
		//-------------------------------------
		var autocomplete_req = { cmd: "find", field: '.Data.Last_Name', table: m.lookup5,query:query, options: {}, skip: 0, limit: 10 }
		var autocomplete_callback = function (item) {
			$('input[name=Appointment]').val(item.Appointment);
			$('input[name=Appointment_uid]').val(item.UID);
			$('input[name=pw]').val(item.pw);
			a_rid=item.id
		}
		var autocomplete_list = function (records) {
			var items = [];
			for (var i = 0; i < records.length; i++) {
				var obj = {};
				obj.label = records[i].Data["First_Name"] + " " + records[i].Data["Last_Name"];
				obj.UID = records[i].UID;
				obj.pw = records[i].Data["_Password"];
				obj.id = records[i]._id;
				items.push(obj);
			}
			return items;
		}
		var wait1 = function () {
			$vm.autocomplete($('#F__ID input[name=Appointment]'), autocomplete_req, autocomplete_list, autocomplete_callback);
		}
		var I = 0; var loop_1 = setInterval(function () {
			if ($vm['jquery-ui-min-js'] != undefined) { clearInterval(loop_1); wait1(); }
			I++; if (I > 50) { clearInterval(loop_1); alert("jquery-ui.min.js is not installed."); }
		}, 100);
		//-------------------------------------
		var autocomplete_req2 = { cmd: "find", field: '.Data.Item_Number', table: m.lookup2, options: {}, skip: 0, limit: 10 }
		var autocomplete_callback2 = function (item) {
			$('input[name=Item_Number_Procedure]').val(item.label);
			$('input[name=Item_Number]').val(item.Item_Number);
			$('input[name=Colour]').val(item.Colour);
			$('input[name=Item_Number_Procedure]').css('background-color', $('#F__ID input[name=Colour]').val());
			$('input[name=Item_Number_Procedure]').css('color', $vm.whire_or_black_color($('#F__ID input[name=Colour]').val()));
			make_questionnaire_list(item.UID);
		}
		var autocomplete_list2 = function (records) {
			var items = [];
			for (var i = 0; i < records.length; i++) {
				var obj = {};
				obj.label = records[i].Data["Item_Number"] + " | " + records[i].Data["Short_Name"];
				obj.Item_Number = records[i].Data["Item_Number"];
				obj.UID = records[i].UID;
				obj.Colour = records[i].Data['Colour'];
				obj.Colour_Text = records[i].Data['Colour_Text'];
				obj.short_name = records[i].Data['Short_Name'];
				items.push(obj);
			}
			return items;
		}
		var wait2 = function () {
			$vm.autocomplete($('#F__ID input[name=Item_Number_Procedure]'), autocomplete_req2, autocomplete_list2, autocomplete_callback2);
		}
		var I2 = 0; var loop_2 = setInterval(function () {
			if ($vm['jquery-ui-min-js'] != undefined) { clearInterval(loop_2); wait2(); }
			I2++; if (I2 > 50) { clearInterval(loop_2); alert("jquery-ui.min.js is not installed."); }
		}, 100);
		//-------------------------------------
		var autocomplete_req3 = { cmd: "find", field: '.Data.Research_Project', table: m.lookup3, options: {}, skip: 0, limit: 10 }
		var autocomplete_callback3 = function (item) {
			$('input[name=Research_Project]').val(item.label);
		}
		var autocomplete_list3 = function (records) {
			var items = [];
			for (var i = 0; i < records.length; i++) {
				var obj = {};
				obj.label = records[i].Data["Research_Project"];
				items.push(obj);
			}
			return items;
		}
		var wait3 = function () {
			$vm.autocomplete($('#F__ID input[name=Research_Project]'), autocomplete_req3, autocomplete_list3, autocomplete_callback3);
		}
		var I3 = 0; var loop_3 = setInterval(function () {
			if ($vm['jquery-ui-min-js'] != undefined) { clearInterval(loop_3); wait3(); }
			I3++; if (I3 > 50) { clearInterval(loop_3); alert("jquery-ui.min.js is not installed."); }
		}, 100);
		//-------------------------------------
		$('#patient_link1__ID').on('click', function () {
			$vm.load_module('patient-data', '', {});
		})
		//-------------------------------------
		$('#patient_link2__ID').on('click', function () {
			var uid = $('input[name=Patient_uid]').val();
			if (uid == "") {
				$vm.alert("No patient was selected.");
				return;
			}
			$vm.request({ cmd: "find", table: m.lookup, query: { UID: parseInt(uid) } }, function (res) {
				if (res.result.length == 1) {
					$vm.load_module('appointment-form', '', { record: res.result[0] });
				}
			});
		})
		//-------------------------------------
		//item a part
		m.item_a_fields = "Title,Name,Location,Provider_Number,Email,_Remove";
		//----------------------------------
		$('#item_a_add__ID').on('click', function () { m.item_a_render(); $('input[name=Report_send_to]').val(""); })
		//----------------------------------
		m.item_a_cell_render = function (records, I, field, td, set_value, source) {
			switch (field) {
			}
		}
		//----------------------------------
		m.item_a_after_change = function (records, I, field, td, set_value, source) {
			switch (field) {
			}
		}
		//----------------------------------
		m.item_a_after_remove = function () {
		}
		//-------------------------------------
		var autocomplete_req4 = { cmd: "find", field: '.Data.Name', table: m.lookup4, options: {}, skip: 0, limit: 10 }
		var autocomplete_callback4 = function (item) {
			$('input[name=Referrer]').val(item.label);
			$('input[name=Referrer_Provider_Number]').val(item.Referrer_Provider_Number);
		}
		var autocomplete_list4 = function (records) {
			var items = [];
			for (var i = 0; i < records.length; i++) {
				var obj = {};
				obj.label = records[i].Data["Name"] + " | " + records[i].Data["Location"];
				obj.Referrer_Provider_Number = records[i].Data["Provider_Number"];
				items.push(obj);
			}
			return items;
		}
		var wait4 = function () {
			$vm.autocomplete($('#F__ID input[name=Referrer'), autocomplete_req4, autocomplete_list4, autocomplete_callback4);
		}
		var I4 = 0; var loop_4 = setInterval(function () {
			if ($vm['jquery-ui-min-js'] != undefined) { clearInterval(loop_4); wait4(); }
			I4++; if (I4 > 50) { clearInterval(loop_4); alert("jquery-ui.min.js is not installed."); }
		}, 100);

		//-------------------------------------
		var autocomplete_callback5 = function (item) {
			$('input[name=Report_send_to]').val(item.label);
			//console.log(item.Title)
			var ttt = {}
			ttt.Title = item.Title;
			ttt.Name = item.Name;
			ttt.Location = item.Location;
			ttt.Provider_Number = item.Provider_Number;
			ttt.Email = item.Email;
			m.item_a_records.push(ttt)
		}
		var autocomplete_list5 = function (records) {
			var items = [];
			for (var i = 0; i < records.length; i++) {
				var obj = {};
				obj.label = records[i].Data["Name"] + " | " + records[i].Data["Email"] + " | " + records[i].Data["Location"];
				obj.Title = records[i].Data["Title"];
				obj.Name = records[i].Data["Name"];
				obj.Location = records[i].Data["Location"];
				obj.Provider_Number = records[i].Data["Provider_Number"];
				obj.Email = records[i].Data["Email"];
				items.push(obj);
			}
			return items;
		}
		var wait5 = function () {
			$vm.autocomplete($('#F__ID input[name=Report_send_to]'), autocomplete_req4, autocomplete_list5, autocomplete_callback5);
		}
		var I5 = 0; var loop_5 = setInterval(function () {
			if ($vm['jquery-ui-min-js'] != undefined) { clearInterval(loop_5); wait5(); }
			I5++; if (I5 > 50) { clearInterval(loop_5); alert("jquery-ui.min.js is not installed."); }
		}, 100);

	}
		//-------------------------------

</script>
<style>
	#form_container__ID {
		max-width: 800px;
	}

	VmInclude:__CURRENT_PATH__/wappsystem-form.css
	VmInclude:__COMPONENT__/f/form-item-a.01.css
</style>
</div>